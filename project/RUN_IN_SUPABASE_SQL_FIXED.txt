-- COPY AND PASTE ALL OF THIS INTO SUPABASE SQL EDITOR
-- This is the FIXED version that handles data types correctly

-- ============================================
-- PREDICTIVE BURNOUT ALGORITHM (PBA) FUNCTION - FIXED VERSION
-- ============================================

CREATE OR REPLACE FUNCTION predict_burnout_risk(p_user_id uuid)
RETURNS json AS $$
DECLARE
  v_risk_score numeric;
  v_factors json;
  v_weeks_until_burnout integer;
  v_trend text;
BEGIN
  -- Analyze patterns from reflection_entries table
  WITH patterns AS (
    SELECT
      -- Energy metrics (handle both string and numeric data)
      AVG(
        CASE
          WHEN jsonb_typeof(data->'energy_level') = 'number' THEN (data->>'energy_level')::numeric
          WHEN data->>'energy_level' IS NOT NULL THEN (data->>'energy_level')::numeric
          ELSE 5
        END
      ) AS avg_energy,

      STDDEV(
        CASE
          WHEN jsonb_typeof(data->'energy_level') = 'number' THEN (data->>'energy_level')::numeric
          WHEN data->>'energy_level' IS NOT NULL THEN (data->>'energy_level')::numeric
          ELSE 5
        END
      ) AS energy_variance,

      COUNT(*) FILTER (
        WHERE CASE
          WHEN jsonb_typeof(data->'energy_level') = 'number' THEN (data->>'energy_level')::numeric
          WHEN data->>'energy_level' IS NOT NULL THEN (data->>'energy_level')::numeric
          ELSE 5
        END < 4
      ) AS low_energy_days,

      -- Stress metrics (handle both string and numeric data)
      AVG(
        CASE
          WHEN jsonb_typeof(data->'stress_level') = 'number' THEN (data->>'stress_level')::numeric
          WHEN data->>'stress_level' IS NOT NULL THEN (data->>'stress_level')::numeric
          ELSE 5
        END
      ) AS avg_stress,

      COUNT(*) FILTER (
        WHERE CASE
          WHEN jsonb_typeof(data->'stress_level') = 'number' THEN (data->>'stress_level')::numeric
          WHEN data->>'stress_level' IS NOT NULL THEN (data->>'stress_level')::numeric
          ELSE 5
        END > 7
      ) AS high_stress_days,

      -- Burnout specific metrics
      AVG(
        CASE
          WHEN jsonb_typeof(data->'burnout_score') = 'number' THEN (data->>'burnout_score')::numeric
          WHEN data->>'burnout_score' IS NOT NULL THEN (data->>'burnout_score')::numeric
          ELSE 0
        END
      ) AS avg_burnout,

      MAX(
        CASE
          WHEN jsonb_typeof(data->'burnout_score') = 'number' THEN (data->>'burnout_score')::numeric
          WHEN data->>'burnout_score' IS NOT NULL THEN (data->>'burnout_score')::numeric
          ELSE 0
        END
      ) AS peak_burnout,

      -- Engagement metrics
      COUNT(DISTINCT entry_kind) AS activity_variety,
      COUNT(*) AS total_reflections,
      EXTRACT(DAY FROM (MAX(created_at) - MIN(created_at))) AS timespan_days,
      MAX(created_at) AS last_check_in

    FROM reflection_entries
    WHERE user_id = p_user_id
      AND created_at > NOW() - INTERVAL '14 days'
      AND data IS NOT NULL
  ),
  trend_analysis AS (
    -- Compare current week vs previous week
    SELECT
      AVG(
        CASE
          WHEN created_at > NOW() - INTERVAL '7 days' THEN
            CASE
              WHEN jsonb_typeof(data->'energy_level') = 'number' THEN (data->>'energy_level')::numeric
              WHEN data->>'energy_level' IS NOT NULL THEN (data->>'energy_level')::numeric
              ELSE 5
            END
          ELSE NULL
        END
      ) AS current_week_energy,

      AVG(
        CASE
          WHEN created_at <= NOW() - INTERVAL '7 days' AND created_at > NOW() - INTERVAL '14 days' THEN
            CASE
              WHEN jsonb_typeof(data->'energy_level') = 'number' THEN (data->>'energy_level')::numeric
              WHEN data->>'energy_level' IS NOT NULL THEN (data->>'energy_level')::numeric
              ELSE 5
            END
          ELSE NULL
        END
      ) AS previous_week_energy,

      AVG(
        CASE
          WHEN created_at > NOW() - INTERVAL '7 days' THEN
            CASE
              WHEN jsonb_typeof(data->'stress_level') = 'number' THEN (data->>'stress_level')::numeric
              WHEN data->>'stress_level' IS NOT NULL THEN (data->>'stress_level')::numeric
              ELSE 5
            END
          ELSE NULL
        END
      ) AS current_week_stress,

      AVG(
        CASE
          WHEN created_at <= NOW() - INTERVAL '7 days' AND created_at > NOW() - INTERVAL '14 days' THEN
            CASE
              WHEN jsonb_typeof(data->'stress_level') = 'number' THEN (data->>'stress_level')::numeric
              WHEN data->>'stress_level' IS NOT NULL THEN (data->>'stress_level')::numeric
              ELSE 5
            END
          ELSE NULL
        END
      ) AS previous_week_stress

    FROM reflection_entries
    WHERE user_id = p_user_id
      AND created_at > NOW() - INTERVAL '14 days'
      AND data IS NOT NULL
  )
  SELECT
    -- Calculate comprehensive risk score (0-10 scale)
    LEAST(10, GREATEST(0,
      (10 - COALESCE(p.avg_energy, 5)) * 0.25 +           -- Lower energy = higher risk
      COALESCE(p.energy_variance, 0) * 0.15 +             -- Instability = higher risk
      COALESCE(p.low_energy_days, 0) * 0.15 +             -- Frequency of bad days
      COALESCE(p.avg_stress, 5) * 0.15 +                  -- High stress
      COALESCE(p.high_stress_days, 0) * 0.1 +             -- Frequent high stress
      COALESCE(p.avg_burnout, 0) * 0.1 +                  -- Current burnout level
      (CASE
        WHEN p.activity_variety < 3 THEN 2               -- Low engagement variety
        WHEN p.total_reflections < 3 THEN 3              -- Low engagement frequency
        ELSE 0
      END) * 0.1
    )),
    json_build_object(
      'energy_trend', COALESCE(p.avg_energy, 5),
      'energy_stability', COALESCE(p.energy_variance, 0),
      'low_energy_frequency', COALESCE(p.low_energy_days, 0),
      'stress_level', COALESCE(p.avg_stress, 5),
      'high_stress_frequency', COALESCE(p.high_stress_days, 0),
      'burnout_current', COALESCE(p.avg_burnout, 0),
      'burnout_peak', COALESCE(p.peak_burnout, 0),
      'engagement_variety', COALESCE(p.activity_variety, 0),
      'engagement_days', COALESCE(p.total_reflections, 0),
      'timespan_days', COALESCE(p.timespan_days, 0),
      'last_check_in', COALESCE(p.last_check_in::text, NOW()::text),
      'chronic_stress_detected', COALESCE(p.high_stress_days, 0) >= 5,
      'recovery_needed', COALESCE(p.avg_energy, 5) < 4 AND COALESCE(p.avg_stress, 5) > 6,
      'confidence_level', CASE
        WHEN p.total_reflections >= 7 THEN 0.9
        WHEN p.total_reflections >= 4 THEN 0.7
        WHEN p.total_reflections >= 2 THEN 0.5
        ELSE 0.3
      END,
      'trend_direction', CASE
        WHEN t.current_week_energy > COALESCE(t.previous_week_energy, 5) + 0.5 THEN 'improving'
        WHEN t.current_week_energy < COALESCE(t.previous_week_energy, 5) - 0.5 THEN 'worsening'
        ELSE 'stable'
      END
    )
  INTO v_risk_score, v_factors
  FROM patterns p
  CROSS JOIN trend_analysis t;

  -- Calculate weeks until potential burnout based on trend
  v_weeks_until_burnout := CASE
    WHEN v_risk_score >= 8 THEN 1  -- Already at critical risk
    WHEN v_risk_score >= 6 THEN 2  -- High risk, burnout imminent
    WHEN v_risk_score >= 4 AND (v_factors->>'trend_direction')::text = 'worsening' THEN 3
    WHEN v_risk_score >= 3 AND (v_factors->>'trend_direction')::text = 'worsening' THEN 4
    ELSE NULL  -- Risk too low to predict
  END;

  -- Determine trend
  v_trend := COALESCE((v_factors->>'trend_direction')::text, 'stable');

  RETURN json_build_object(
    'risk_score', ROUND(v_risk_score, 1),
    'risk_level', CASE
      WHEN v_risk_score >= 8 THEN 'critical'
      WHEN v_risk_score >= 6 THEN 'high'
      WHEN v_risk_score >= 4 THEN 'moderate'
      WHEN v_risk_score >= 2 THEN 'low'
      ELSE 'minimal'
    END,
    'trend', v_trend,
    'weeks_until_burnout', v_weeks_until_burnout,
    'intervention_urgency', CASE
      WHEN v_risk_score >= 8 THEN 'immediate'
      WHEN v_risk_score >= 6 THEN 'urgent'
      WHEN v_risk_score >= 4 THEN 'recommended'
      ELSE 'monitoring'
    END,
    'factors', v_factors,
    'recommended_actions', CASE
      WHEN v_risk_score >= 8 THEN
        ARRAY['Take immediate wellness break', 'Schedule supervisor check-in', 'Access crisis support']
      WHEN v_risk_score >= 6 THEN
        ARRAY['Review and adjust workload', 'Implement daily stress reduction', 'Connect with peer support']
      WHEN v_risk_score >= 4 THEN
        ARRAY['Establish weekly reflection practice', 'Build resilience skills', 'Monitor stress patterns']
      ELSE
        ARRAY['Maintain current wellness practices', 'Continue regular check-ins']
    END,
    'assessment_date', NOW()::text
  );
END;
$$ LANGUAGE plpgsql;

-- Grant execute permissions
GRANT EXECUTE ON FUNCTION predict_burnout_risk(uuid) TO authenticated;

-- Create an index to speed up the function
CREATE INDEX IF NOT EXISTS idx_reflection_entries_user_created
ON reflection_entries(user_id, created_at DESC);

-- Test the function (replace with your actual user ID)
-- SELECT predict_burnout_risk('your-user-id-here'::uuid);